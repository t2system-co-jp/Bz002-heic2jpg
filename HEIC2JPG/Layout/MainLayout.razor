@inherits LayoutComponentBase
@inject ILocalizationService Localizer
@inject NetworkMonitorService NetworkMonitor
@inject IJSRuntime JS
@implements IDisposable

<div class="app-layout">
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <div class="emoji-logo">
                    <span class="emoji-base">☁️</span>
                    <span class="emoji-overlay">🚫</span>
                </div>
                <h1 class="app-title">@Localizer.GetString("App.Title")</h1>
            </div>
            <div class="header-right">
                <NetworkShield />
                <ThemeToggle />
                <LanguageSelector />
            </div>
        </div>
    </header>

    <main class="app-main">
        @Body
    </main>

    <!-- Toast通知コンテナ -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    </div>
</div>

@code {
    private bool _initialized = false;

    protected override void OnInitialized()
    {
        // 言語変更イベントを購読
        Localizer.LanguageChanged += OnLanguageChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;

            // NetworkMonitorService 初期化
            await NetworkMonitor.InitializeAsync();

            if (Localizer is LocalizationService service)
            {
                await service.InitializeAsync();
                await UpdateJavaScriptStrings();
                StateHasChanged();
            }
            else
            {
                await UpdateJavaScriptStrings();
            }
        }
    }

    private async void OnLanguageChanged(object? sender, EventArgs e)
    {
        // 言語が変更されたらレイアウト全体を再描画
        await UpdateJavaScriptStrings(); // JS辞書を更新
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// JavaScript用のローカライズ辞書を更新
    /// </summary>
    private async Task UpdateJavaScriptStrings()
    {
        try
        {
            var jsStrings = Localizer.GetJavaScriptStrings();
            await JS.InvokeVoidAsync("window.updateLocalizationStrings", jsStrings);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JavaScript辞書更新エラー: {ex.Message}");
        }
    }

    public void Dispose()
    {
        // イベント購読解除
        Localizer.LanguageChanged -= OnLanguageChanged;
    }
}


