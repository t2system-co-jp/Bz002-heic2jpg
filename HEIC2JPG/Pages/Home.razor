@page "/"
@using HEIC2JPG.Models
@using HEIC2JPG.Services
@inject IConvertService ConvertService
@inject ILocalizationService Localizer
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>@Localizer.GetString("App.Title")</PageTitle>

<div class="converter-container">
    <!-- „Éí„Éº„É≠„Éº„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <HeroSection OnStartConversion="ScrollToDropZone" OnShowGuide="ToggleGuide" />

    <!-- ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ -->
    <UsageGuide @bind-IsExpanded="isGuideExpanded" />

    <div class="converter-layout">
        <!-- „É°„Ç§„É≥„Ç®„É™„Ç¢ -->
        <div class="main-area">
            <!-- „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥ -->
            <div class="drop-zone" @ref="dropZoneElement"
                 role="button"
                 aria-label="@Localizer.GetString("DropZone.AriaLabel")">
                <div class="drop-content">
                    <div class="drop-icon">üìÅ</div>
                    <h3>@Localizer.GetString("DropZone.Title")</h3>
                    <p>@Localizer.GetString("DropZone.Description")</p>
                    <div class="file-limits-notice">
                        <span class="limits-icon">‚ÑπÔ∏è</span>
                        <span>@Localizer.GetString("DropZone.FileLimits")</span>
                    </div>
                </div>

                <!-- InputFile„Çí„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥ÂÖ®‰Ωì„Å´ÈÄèÊòéÈÖçÁΩÆ -->
                <InputFile @ref="fileInput"
                          OnChange="OnFilesSelected"
                          multiple
                          accept=".heic,.mov"
                          class="drop-zone-input" />
            </div>

            <!-- „Éï„Ç°„Ç§„É´„Ç≠„É•„Éº -->
            @if (files.Any())
            {
                <div class="file-queue" role="region" aria-label="@Localizer.GetString("FileQueue.AriaLabel", files.Count)">
                    <div class="queue-header">
                        <h3>@Localizer.GetString("FileQueue.Title") (@files.Count)</h3>
                        <div class="queue-controls">
                            <button class="btn btn-primary" @onclick="StartConversion" disabled="@isProcessing">
                                ‚ñ∂Ô∏è @Localizer.GetString("Button.Start")
                            </button>
                            <button class="btn btn-download-all" @onclick="DownloadAll"
                                   disabled="@(!files.Any(f => f.Status == ConversionStatus.Completed))">
                                üì¶ @Localizer.GetString("Button.DownloadAll")
                            </button>
                            <button class="btn btn-clear" @onclick="ClearQueue" disabled="@isProcessing">
                                üóëÔ∏è @Localizer.GetString("Button.Clear")
                            </button>
                        </div>
                    </div>

                    <!-- „Éï„Ç°„Ç§„É´„É™„Çπ„Éà -->
                    @foreach (var file in files)
                    {
                        <div class="file-item">
                            <div class="file-icon">
                                @(file.Type == FileType.HEIC ? "üñºÔ∏è" : "üé¨")
                            </div>
                            <div class="file-info">
                                <div class="file-name" title="@file.FileName">@file.FileName</div>
                                <div class="file-size">@FormatFileSize(file.FileSize)</div>
                            </div>
                            <div class="file-status status-@file.Status.ToString().ToLower()">
                                @if (file.Status == ConversionStatus.Processing)
                                {
                                    <div class="progress-container">
                                        <div class="progress-bar-wrapper">
                                            <div class="progress-bar" style="width: @file.Progress%"></div>
                                        </div>
                                        <span class="progress-text">@file.Progress%</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="status">@GetStatusText(file.Status)</span>
                                }
                                @if (file.Status == ConversionStatus.Error && !string.IsNullOrEmpty(file.ErrorMessage))
                                {
                                    <div class="error-message">
                                        <span class="error-icon">‚ö†Ô∏è</span>
                                        <span class="error-text">@file.ErrorMessage</span>
                                    </div>
                                }
                            </div>
                            <div class="file-actions">
                                @if (file.Status == ConversionStatus.Completed)
                                {
                                    <button class="btn-download" @onclick="() => DownloadFile(file)" title="@Localizer.GetString("Button.Download")">
                                        üíæ
                                    </button>
                                }
                                <button class="btn-remove" @onclick="() => RemoveFile(file)"
                                       disabled="@(file.Status == ConversionStatus.Processing)" title="@Localizer.GetString("Button.Delete")">
                                    ‚ùå
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
        <div class="settings-panel @(isSettingsExpanded ? "expanded" : "collapsed")">
            <div class="settings-header" @onclick="ToggleSettings" role="button" tabindex="0"
                 @onkeydown="@(e => { if (e.Key == "Enter" || e.Key == " ") ToggleSettings(); })"
                 aria-expanded="@isSettingsExpanded" aria-controls="settings-content">
                <h3>‚öôÔ∏è @Localizer.GetString("Settings.Title")</h3>
                <span class="settings-toggle-icon">@(isSettingsExpanded ? "‚ñº" : "‚ñ∂")</span>
            </div>

            <div id="settings-content" class="settings-content" aria-hidden="@(!isSettingsExpanded)">
                <div class="setting">
                    <label for="jpgQuality">@Localizer.GetString("Settings.JpgQuality"): @((settings.JpgQuality * 100).ToString("F0"))%</label>
                    <input type="range" id="jpgQuality"
                           @bind="settings.JpgQuality"
                           min="@MIN_JPG_QUALITY" max="@MAX_JPG_QUALITY" step="@JPG_QUALITY_STEP" />
                </div>

                <div class="setting">
                    <label>
                        <input type="checkbox" @bind="settings.PreserveExif" />
                        @Localizer.GetString("Settings.PreserveExif")
                    </label>
                </div>

                <div class="setting">
                    <label for="conversionMode">@Localizer.GetString("Settings.ConversionMode")</label>
                    <select id="conversionMode" @bind="settings.ConversionMode">
                        <option value="Auto">@Localizer.GetString("Settings.ConversionMode.Auto")</option>
                        <option value="Fast">@Localizer.GetString("Settings.ConversionMode.Fast")</option>
                        <option value="Quality">@Localizer.GetString("Settings.ConversionMode.HighQuality")</option>
                    </select>
                </div>

                <div class="setting">
                    <label for="parallelCount">@Localizer.GetString("Settings.ParallelCount"): @settings.ParallelCount</label>
                    <input type="range" id="parallelCount"
                           @bind="settings.ParallelCount"
                           min="@MIN_PARALLEL_COUNT" max="@MAX_PARALLEL_COUNT" step="1" />
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // ÂÆöÊï∞ÂÆöÁæ©
    private const int MAX_FILES = 100;
    private const double MIN_JPG_QUALITY = 0.6;
    private const double MAX_JPG_QUALITY = 1.0;
    private const double JPG_QUALITY_STEP = 0.1;
    private const int MIN_PARALLEL_COUNT = 1;
    private const int MAX_PARALLEL_COUNT = 4;
    private const int BYTES_PER_KB = 1024;

    private InputFile? fileInput;
    private List<ConvertFile> files = new();
    private ConversionSettings settings = new();
    private bool isProcessing = false;
    private bool isSettingsExpanded = false; // „Éá„Éï„Ç©„É´„Éà„ÅßÊäò„Çä„Åü„Åü„ÅøÔºàÂàùÂøÉËÄÖÂêë„Åë„Å´„Ç∑„É≥„Éó„É´„Å™ÂàùÊúüË°®Á§∫Ôºâ
    private bool isGuideExpanded = false; // ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ„ÅÆÂàùÊúüÁä∂ÊÖãÔºàÂàùÂøÉËÄÖ„ÅåÂøÖË¶ÅÊôÇ„Å´Â±ïÈñãÔºâ
    private ElementReference dropZoneElement;

    private async Task ScrollToDropZone()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToElement", dropZoneElement);
        }
        catch
        {
            // „Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºàÂè§„ÅÑ„Éñ„É©„Ç¶„Ç∂ÂØæÂøúÔºâ
        }
    }

    private void ToggleGuide()
    {
        isGuideExpanded = !isGuideExpanded;
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles(MAX_FILES))
        {
            var convertFile = new ConvertFile
            {
                Id = Guid.NewGuid(),
                FileName = file.Name,
                FileSize = file.Size,
                Type = GetFileType(file.Name),
                Status = ConversionStatus.Pending,
                OriginalFile = file
            };

            files.Add(convertFile);
        }
        StateHasChanged();
    }

    private async Task StartConversion()
    {
        isProcessing = true;
        try
        {
            var pendingFiles = files.Where(f => f.Status == ConversionStatus.Pending).ToList();
            await ConvertService.ConvertFilesAsync(pendingFiles, settings, OnProgressUpdate);
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void OnProgressUpdate(Guid fileId, int progress)
    {
        var file = files.FirstOrDefault(f => f.Id == fileId);
        if (file != null)
        {
            file.Progress = progress;
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task DownloadFile(ConvertFile file)
    {
        if (file.ConvertedData != null)
        {
            await JS.InvokeVoidAsync("downloadFile", file.ConvertedData, file.GetConvertedFileName());
        }
    }

    private async Task DownloadAll()
    {
        var completedFiles = files.Where(f => f.Status == ConversionStatus.Completed).ToList();
        if (completedFiles.Any())
        {
            await JS.InvokeVoidAsync("downloadFilesAsZip", completedFiles.Select(f => new {
                data = f.ConvertedData,
                fileName = f.GetConvertedFileName()
            }).ToArray());
        }
    }

    private void RemoveFile(ConvertFile file)
    {
        files.Remove(file);
        StateHasChanged();
    }

    private void ClearQueue()
    {
        files.Clear();
        StateHasChanged();
    }

    private FileType GetFileType(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".heic" => FileType.HEIC,
            ".mov" => FileType.MOV,
            _ => FileType.Unknown
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= BYTES_PER_KB && order < sizes.Length - 1)
        {
            order++;
            len = len / BYTES_PER_KB;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetStatusText(ConversionStatus status)
    {
        return status switch
        {
            ConversionStatus.Pending => Localizer.GetString("Status.Pending"),
            ConversionStatus.Processing => Localizer.GetString("Status.Processing"),
            ConversionStatus.Completed => Localizer.GetString("Status.Completed"),
            ConversionStatus.Error => Localizer.GetString("Status.Error"),
            ConversionStatus.Cancelled => Localizer.GetString("Status.Cancelled"),
            _ => Localizer.GetString("Status.Unknown")
        };
    }

    private void ToggleSettings()
    {
        isSettingsExpanded = !isSettingsExpanded;
    }

    protected override void OnInitialized()
    {
        // Ë®ÄË™ûÂ§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíË≥ºË™≠
        Localizer.LanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged(object? sender, EventArgs e)
    {
        // Ë®ÄË™û„ÅåÂ§âÊõ¥„Åï„Çå„Åü„ÇâUIÂÜçÊèèÁîª
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // „Ç§„Éô„É≥„ÉàË≥ºË™≠Ëß£Èô§
        Localizer.LanguageChanged -= OnLanguageChanged;
    }
}