@page "/"
@using HEIC2JPG.Models
@using HEIC2JPG.Services
@inject IConvertService ConvertService
@inject IJSRuntime JS

<PageTitle>HEIC2JPG & MOV2MP4</PageTitle>

<div class="converter-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="converter-header">
        <h1>HEIC2JPG & MOV2MP4</h1>
        <p>ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµå‹ãƒ¡ãƒ‡ã‚£ã‚¢å¤‰æ›ã‚¢ãƒ—ãƒª - ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å¤–ã¸é€ä¿¡ã•ã‚Œã¾ã›ã‚“</p>
    </div>

    <div class="converter-layout">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="main-area">
            <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
            <div class="drop-zone @(isDragActive ? "drag-active" : "")" 
                 @ondragover="OnDragOver" 
                 @ondragover:preventDefault="true"
                 @ondrop="OnDrop" 
                 @ondrop:preventDefault="true"
                 @ondragenter="OnDragEnter"
                 @ondragleave="OnDragLeave"
                 @onclick="SelectFiles">
                <div class="drop-content">
                    <div class="drop-icon">ğŸ“</div>
                    <h3>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠ</h3>
                    <p>HEICç”»åƒãƒ»MOVå‹•ç”»ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
                    <button type="button" class="btn-select">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                    <small>æœ€å¤§100ãƒ•ã‚¡ã‚¤ãƒ«ã€2GB/ãƒ•ã‚¡ã‚¤ãƒ«</small>
                </div>
            </div>

            <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
            <InputFile @ref="fileInput" 
                      OnChange="OnFilesSelected" 
                      multiple 
                      accept=".heic,.mov"
                      style="display: none;" />

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¥ãƒ¼ -->
            @if (files.Any())
            {
                <div class="file-queue">
                    <div class="queue-header">
                        <h3>å¤‰æ›ã‚­ãƒ¥ãƒ¼ (@files.Count ãƒ•ã‚¡ã‚¤ãƒ«)</h3>
                        <div class="queue-controls">
                            <button class="btn btn-primary" @onclick="StartConversion" disabled="@isProcessing">
                                â–¶ï¸ é–‹å§‹
                            </button>
                            <button class="btn btn-download-all" @onclick="DownloadAll" 
                                   disabled="@(!files.Any(f => f.Status == ConversionStatus.Completed))">
                                ğŸ“¦ ä¸€æ‹¬DL
                            </button>
                            <button class="btn btn-clear" @onclick="ClearQueue" disabled="@isProcessing">
                                ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
                    @foreach (var file in files)
                    {
                        <div class="file-item">
                            <div class="file-icon">
                                @(file.Type == FileType.HEIC ? "ğŸ–¼ï¸" : "ğŸ¬")
                            </div>
                            <div class="file-info">
                                <div class="file-name" title="@file.FileName">@file.FileName</div>
                                <div class="file-size">@FormatFileSize(file.FileSize)</div>
                            </div>
                            <div class="file-status status-@file.Status.ToString().ToLower()">
                                @if (file.Status == ConversionStatus.Processing)
                                {
                                    <div class="progress">@file.Progress%</div>
                                }
                                else
                                {
                                    <span class="status">@GetStatusText(file.Status)</span>
                                }
                                @if (file.Status == ConversionStatus.Error && !string.IsNullOrEmpty(file.ErrorMessage))
                                {
                                    <span class="error-status" title="@file.ErrorMessage">âš ï¸</span>
                                }
                            </div>
                            <div class="file-actions">
                                @if (file.Status == ConversionStatus.Completed)
                                {
                                    <button class="btn-download" @onclick="() => DownloadFile(file)" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                        ğŸ’¾
                                    </button>
                                }
                                <button class="btn-remove" @onclick="() => RemoveFile(file)" 
                                       disabled="@(file.Status == ConversionStatus.Processing)" title="å‰Šé™¤">
                                    âŒ
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="settings-panel">
            <h3>âš™ï¸ å¤‰æ›è¨­å®š</h3>
            
            <div class="setting">
                <label for="jpgQuality">JPGå“è³ª: @((settings.JpgQuality * 100).ToString("F0"))%</label>
                <input type="range" id="jpgQuality" 
                       @bind="settings.JpgQuality" 
                       min="0.6" max="1.0" step="0.1" />
            </div>

            <div class="setting">
                <label>
                    <input type="checkbox" @bind="settings.PreserveExif" />
                    EXIFæƒ…å ±ã‚’ä¿æŒ
                </label>
            </div>

            <div class="setting">
                <label for="conversionMode">å¤‰æ›æ–¹å¼</label>
                <select id="conversionMode" @bind="settings.ConversionMode">
                    <option value="Auto">è‡ªå‹•</option>
                    <option value="Fast">é«˜é€Ÿ</option>
                    <option value="Quality">é«˜å“è³ª</option>
                </select>
            </div>

            <div class="setting">
                <label for="parallelCount">ä¸¦åˆ—å‡¦ç†æ•°: @settings.ParallelCount</label>
                <input type="range" id="parallelCount" 
                       @bind="settings.ParallelCount" 
                       min="1" max="4" step="1" />
            </div>
        </div>
    </div>
</div>

@code {
    private InputFile? fileInput;
    private List<ConvertFile> files = new();
    private ConversionSettings settings = new();
    private bool isDragActive = false;
    private bool isProcessing = false;

    private async Task SelectFiles()
    {
        await JS.InvokeVoidAsync("triggerFileInput", fileInput?.Element);
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles(100))
        {
            var convertFile = new ConvertFile
            {
                Id = Guid.NewGuid(),
                FileName = file.Name,
                FileSize = file.Size,
                Type = GetFileType(file.Name),
                Status = ConversionStatus.Pending,
                OriginalFile = file
            };

            files.Add(convertFile);
        }
        StateHasChanged();
    }

    private void OnDragEnter() => isDragActive = true;
    private void OnDragLeave() => isDragActive = false;
    private void OnDragOver() { /* preventDefault in markup */ }

    private async Task OnDrop()
    {
        isDragActive = false;
        // JSInteropã§ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
        await JS.InvokeVoidAsync("handleFileDrop");
    }

    private async Task StartConversion()
    {
        isProcessing = true;
        try
        {
            var pendingFiles = files.Where(f => f.Status == ConversionStatus.Pending).ToList();
            await ConvertService.ConvertFilesAsync(pendingFiles, settings, OnProgressUpdate);
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void OnProgressUpdate(Guid fileId, int progress)
    {
        var file = files.FirstOrDefault(f => f.Id == fileId);
        if (file != null)
        {
            file.Progress = progress;
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task DownloadFile(ConvertFile file)
    {
        if (file.ConvertedData != null)
        {
            await JS.InvokeVoidAsync("downloadFile", file.ConvertedData, file.GetConvertedFileName());
        }
    }

    private async Task DownloadAll()
    {
        var completedFiles = files.Where(f => f.Status == ConversionStatus.Completed).ToList();
        if (completedFiles.Any())
        {
            await JS.InvokeVoidAsync("downloadFilesAsZip", completedFiles.Select(f => new { 
                data = f.ConvertedData, 
                name = f.GetConvertedFileName() 
            }));
        }
    }

    private void RemoveFile(ConvertFile file)
    {
        files.Remove(file);
        StateHasChanged();
    }

    private void ClearQueue()
    {
        files.Clear();
        StateHasChanged();
    }

    private FileType GetFileType(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".heic" => FileType.HEIC,
            ".mov" => FileType.MOV,
            _ => FileType.Unknown
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetStatusText(ConversionStatus status)
    {
        return status switch
        {
            ConversionStatus.Pending => "å¾…æ©Ÿä¸­",
            ConversionStatus.Processing => "å‡¦ç†ä¸­",
            ConversionStatus.Completed => "å®Œäº†",
            ConversionStatus.Error => "ã‚¨ãƒ©ãƒ¼",
            ConversionStatus.Cancelled => "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            _ => "ä¸æ˜"
        };
    }
}