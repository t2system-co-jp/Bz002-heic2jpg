@page "/"
@using HEIC2JPG.Models
@using HEIC2JPG.Services
@inject IConvertService ConvertService
@inject ILocalizationService Localizer
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>@Localizer.GetString("App.Title")</PageTitle>

<div class="converter-container">
    <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <HeroSection OnStartConversion="ScrollToDropZone" OnShowGuide="ToggleGuide" />

    <!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
    <UsageGuide @bind-IsExpanded="isGuideExpanded" />

    <div class="converter-layout">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="main-area">
            <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
            <div class="drop-zone" @ref="dropZoneElement"
                 role="button"
                 aria-label="@Localizer.GetString("DropZone.AriaLabel")">
                <div class="drop-content">
                    <div class="drop-icon">ğŸ“</div>
                    <h3>@Localizer.GetString("DropZone.Title")</h3>
                    <p>@Localizer.GetString("DropZone.Description")</p>
                    <div class="file-limits-notice">
                        <span class="limits-icon">â„¹ï¸</span>
                        <span>@Localizer.GetString("DropZone.FileLimits")</span>
                    </div>
                </div>

                <!-- InputFileã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³å…¨ä½“ã«é€æ˜é…ç½® -->
                <InputFile @ref="fileInput"
                          OnChange="OnFilesSelected"
                          multiple
                          accept=".heic,.mov"
                          class="drop-zone-input" />
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¥ãƒ¼ -->
            @if (files.Any())
            {
                <div class="file-queue" role="region" aria-label="@Localizer.GetString("FileQueue.AriaLabel", files.Count)">
                    <div class="queue-header">
                        <h3>@Localizer.GetString("FileQueue.Title") (@files.Count)</h3>
                        <div class="queue-controls">
                            <button class="btn btn-primary" @onclick="StartConversion" disabled="@isProcessing">
                                â–¶ï¸ @Localizer.GetString("Button.Start")
                            </button>
                            <button class="btn btn-download-all" @onclick="DownloadAll"
                                   disabled="@(!files.Any(f => f.Status == ConversionStatus.Completed))">
                                ğŸ“¦ @Localizer.GetString("Button.DownloadAll")
                            </button>
                            <button class="btn btn-clear" @onclick="ClearQueue" disabled="@isProcessing">
                                ğŸ—‘ï¸ @Localizer.GetString("Button.Clear")
                            </button>
                        </div>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
                    @foreach (var file in files)
                    {
                        <div class="file-item">
                            <div class="file-icon">
                                @(file.Type == FileType.HEIC ? "ğŸ–¼ï¸" : "ğŸ¬")
                            </div>
                            <div class="file-info">
                                <div class="file-name" title="@file.FileName">@file.FileName</div>
                                <div class="file-size">@FormatFileSize(file.FileSize)</div>
                            </div>
                            <div class="file-status status-@file.Status.ToString().ToLower()">
                                @if (file.Status == ConversionStatus.Processing)
                                {
                                    <div class="progress-container">
                                        <div class="progress-bar-wrapper">
                                            <div class="progress-bar" style="width: @file.Progress%"></div>
                                        </div>
                                        <span class="progress-text">@file.Progress%</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="status">@GetStatusText(file.Status)</span>
                                }
                                @if (file.Status == ConversionStatus.Error && !string.IsNullOrEmpty(file.ErrorMessage))
                                {
                                    <div class="error-message">
                                        <span class="error-icon">âš ï¸</span>
                                        <span class="error-text">@file.ErrorMessage</span>
                                    </div>
                                }
                            </div>
                            <div class="file-actions">
                                @if (file.Status == ConversionStatus.Completed)
                                {
                                    <button class="btn-download" @onclick="() => DownloadFile(file)" title="@Localizer.GetString("Button.Download")">
                                        ğŸ’¾
                                    </button>
                                }
                                <button class="btn-remove" @onclick="() => RemoveFile(file)"
                                       disabled="@(file.Status == ConversionStatus.Processing)" title="@Localizer.GetString("Button.Delete")">
                                    âŒ
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="settings-panel @(isSettingsExpanded ? "expanded" : "collapsed")">
            <div class="settings-header" @onclick="ToggleSettings" role="button" tabindex="0"
                 @onkeydown="@(e => { if (e.Key == "Enter" || e.Key == " ") ToggleSettings(); })"
                 aria-expanded="@isSettingsExpanded" aria-controls="settings-content">
                <h3>âš™ï¸ @Localizer.GetString("Settings.Title")</h3>
                <span class="settings-toggle-icon">@(isSettingsExpanded ? "â–¼" : "â–¶")</span>
            </div>

            <div id="settings-content" class="settings-content" aria-hidden="@(!isSettingsExpanded)">
                <div class="setting">
                    <label for="jpgQuality">@Localizer.GetString("Settings.JpgQuality"): @((settings.JpgQuality * 100).ToString("F0"))%</label>
                    <input type="range" id="jpgQuality"
                           @bind="settings.JpgQuality"
                           min="@MIN_JPG_QUALITY" max="@MAX_JPG_QUALITY" step="@JPG_QUALITY_STEP" />
                </div>

                <div class="setting">
                    <label>
                        <input type="checkbox" @bind="settings.PreserveExif" />
                        @Localizer.GetString("Settings.PreserveExif")
                    </label>
                </div>

                <div class="setting">
                    <label for="conversionMode">@Localizer.GetString("Settings.ConversionMode")</label>
                    <select id="conversionMode" @bind="settings.ConversionMode">
                        <option value="Auto">@Localizer.GetString("Settings.ConversionMode.Auto")</option>
                        <option value="Fast">@Localizer.GetString("Settings.ConversionMode.Fast")</option>
                        <option value="Quality">@Localizer.GetString("Settings.ConversionMode.HighQuality")</option>
                    </select>
                </div>

                <div class="setting">
                    <label for="parallelCount">@Localizer.GetString("Settings.ParallelCount"): @settings.ParallelCount</label>
                    <input type="range" id="parallelCount"
                           @bind="settings.ParallelCount"
                           min="@MIN_PARALLEL_COUNT" max="@MAX_PARALLEL_COUNT" step="1" />
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // å®šæ•°å®šç¾©
    private const int MAX_FILES = 100;
    private const double MIN_JPG_QUALITY = 0.6;
    private const double MAX_JPG_QUALITY = 1.0;
    private const double JPG_QUALITY_STEP = 0.1;
    private const int MIN_PARALLEL_COUNT = 1;
    private const int MAX_PARALLEL_COUNT = 4;
    private const int BYTES_PER_KB = 1024;

    private InputFile? fileInput;
    private List<ConvertFile> files = new();
    private ConversionSettings settings = new();
    private bool isProcessing = false;
    private bool isSettingsExpanded = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æŠ˜ã‚ŠãŸãŸã¿ï¼ˆåˆå¿ƒè€…å‘ã‘ã«ã‚·ãƒ³ãƒ—ãƒ«ãªåˆæœŸè¡¨ç¤ºï¼‰
    private bool isGuideExpanded = false; // ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã®åˆæœŸçŠ¶æ…‹ï¼ˆåˆå¿ƒè€…ãŒå¿…è¦æ™‚ã«å±•é–‹ï¼‰
    private ElementReference dropZoneElement;

    private async Task ScrollToDropZone()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToElement", dropZoneElement);
        }
        catch
        {
            // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
        }
    }

    private void ToggleGuide()
    {
        isGuideExpanded = !isGuideExpanded;
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        int skippedCount = 0;
        var skippedFiles = new List<string>();

        foreach (var file in e.GetMultipleFiles(MAX_FILES))
        {
            var fileType = GetFileType(file.Name);

            // å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (fileType == FileType.Unknown)
            {
                skippedCount++;
                skippedFiles.Add(file.Name);
                continue; // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ãªã„
            }

            var convertFile = new ConvertFile
            {
                Id = Guid.NewGuid(),
                FileName = file.Name,
                FileSize = file.Size,
                Type = fileType,
                Status = ConversionStatus.Pending,
                OriginalFile = file
            };

            files.Add(convertFile);
        }

        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        if (skippedCount > 0)
        {
            string message;
            if (skippedCount == 1)
            {
                // 1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å«ã‚ã‚‹
                var errorMessage = Localizer.GetString("Error.UnsupportedFileSkipped", skippedFiles[0]);
                var supportedFormats = Localizer.GetString("Error.OnlySupportedFormats");
                message = $"{errorMessage}<br><small>{supportedFormats}</small>";
            }
            else
            {
                // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€ä»¶æ•°ã‚’ã¾ã¨ã‚ã¦è¡¨ç¤º
                var errorMessage = Localizer.GetString("Error.MultipleFilesSkipped", skippedCount);
                var supportedFormats = Localizer.GetString("Error.OnlySupportedFormats");
                message = $"{errorMessage}<br><small>{supportedFormats}</small>";
            }
            JS.InvokeVoidAsync("showToast", message, "warning", 6000);
        }

        StateHasChanged();
    }

    private async Task StartConversion()
    {
        isProcessing = true;
        try
        {
            var pendingFiles = files.Where(f => f.Status == ConversionStatus.Pending).ToList();
            await ConvertService.ConvertFilesAsync(pendingFiles, settings, OnProgressUpdate);
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void OnProgressUpdate(Guid fileId, int progress)
    {
        var file = files.FirstOrDefault(f => f.Id == fileId);
        if (file != null)
        {
            file.Progress = progress;
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task DownloadFile(ConvertFile file)
    {
        if (file.ConvertedData != null)
        {
            await JS.InvokeVoidAsync("downloadFile", file.ConvertedData, file.GetConvertedFileName());
        }
    }

    private async Task DownloadAll()
    {
        var completedFiles = files.Where(f => f.Status == ConversionStatus.Completed).ToList();
        if (completedFiles.Any())
        {
            await JS.InvokeVoidAsync("downloadFilesAsZip", completedFiles.Select(f => new {
                data = f.ConvertedData,
                fileName = f.GetConvertedFileName()
            }).ToArray());
        }
    }

    private void RemoveFile(ConvertFile file)
    {
        files.Remove(file);
        StateHasChanged();
    }

    private void ClearQueue()
    {
        files.Clear();
        StateHasChanged();
    }

    private FileType GetFileType(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".heic" => FileType.HEIC,
            ".mov" => FileType.MOV,
            _ => FileType.Unknown
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= BYTES_PER_KB && order < sizes.Length - 1)
        {
            order++;
            len = len / BYTES_PER_KB;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetStatusText(ConversionStatus status)
    {
        return status switch
        {
            ConversionStatus.Pending => Localizer.GetString("Status.Pending"),
            ConversionStatus.Processing => Localizer.GetString("Status.Processing"),
            ConversionStatus.Completed => Localizer.GetString("Status.Completed"),
            ConversionStatus.Error => Localizer.GetString("Status.Error"),
            ConversionStatus.Cancelled => Localizer.GetString("Status.Cancelled"),
            _ => Localizer.GetString("Status.Unknown")
        };
    }

    private void ToggleSettings()
    {
        isSettingsExpanded = !isSettingsExpanded;
    }

    protected override void OnInitialized()
    {
        // è¨€èªå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
        Localizer.LanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged(object? sender, EventArgs e)
    {
        // è¨€èªãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰UIå†æç”»
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤
        Localizer.LanguageChanged -= OnLanguageChanged;
    }
}