@page "/"
@using HEIC2JPG.Models
@using HEIC2JPG.Services
@inject IConvertService ConvertService
@inject ILocalizationService Localizer
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>@Localizer.GetString("App.Title")</PageTitle>

<div class="converter-container">
    <!-- ヒーローセクション -->
    <HeroSection OnStartConversion="ScrollToDropZone" OnShowGuide="ToggleGuide" />

    <!-- 使い方ガイド -->
    <UsageGuide @bind-IsExpanded="isGuideExpanded" />

    <div class="converter-layout">
        <!-- メインエリア -->
        <div class="main-area">
            <!-- ドロップゾーン -->
            <div class="drop-zone" @ref="dropZoneElement"
                 role="button"
                 aria-label="@Localizer.GetString("DropZone.AriaLabel")">
                <div class="drop-content">
                    <div class="drop-icon"><HeroIcon Name="folder-open" Class="w-16 h-16" /></div>
                    <h3>@Localizer.GetString("DropZone.Title")</h3>
                    <p>@Localizer.GetString("DropZone.Description")</p>
                    <div class="file-limits-notice">
                        <span class="limits-icon"><HeroIcon Name="information-circle" Class="w-5 h-5" /></span>
                        <span>@Localizer.GetString("DropZone.FileLimits")</span>
                    </div>
                </div>

                <!-- InputFileをドロップゾーン全体に透明配置 -->
                <InputFile @ref="fileInput"
                          OnChange="OnFilesSelected"
                          multiple
                          accept=".heic,.mov,.mp4,.avi,.mkv,.wmv,.flv,.webm,.wav,.aac,.m4a,.flac,.wma"
                          class="drop-zone-input" />
            </div>

            <!-- ファイルキュー -->
            @if (files.Any())
            {
                <div class="file-queue" role="region" aria-label="@Localizer.GetString("FileQueue.AriaLabel", files.Count)">
                    <div class="queue-header">
                        <h3>@Localizer.GetString("FileQueue.Title") (@files.Count)</h3>
                        <div class="queue-controls">
                            <button class="btn btn-primary" @onclick="StartConversion" disabled="@isProcessing">
                                <HeroIcon Name="play" Class="w-4 h-4 inline-block mr-1" /> @Localizer.GetString("Button.Start")
                            </button>
                            <button class="btn btn-download-all" @onclick="DownloadAll"
                                   disabled="@(!files.Any(f => f.Status == ConversionStatus.Completed))">
                                <HeroIcon Name="archive-box-arrow-down" Class="w-4 h-4 inline-block mr-1" /> @Localizer.GetString("Button.DownloadAll")
                            </button>
                            <button class="btn btn-clear" @onclick="ClearQueue" disabled="@isProcessing">
                                <HeroIcon Name="trash" Class="w-4 h-4 inline-block mr-1" /> @Localizer.GetString("Button.Clear")
                            </button>
                        </div>
                    </div>

                    <!-- ファイルリスト -->
                    @foreach (var file in files)
                    {
                        <div class="file-item">
                            <div class="file-icon">
                                <HeroIcon Name="@GetFileIconName(file.Type)" Class="w-8 h-8" />
                            </div>
                            <div class="file-info">
                                <div class="file-name" title="@file.FileName">@file.FileName</div>
                                <div class="file-size">@FormatFileSize(file.FileSize)</div>
                            </div>
                            <div class="file-status status-@file.Status.ToString().ToLower()">
                                @if (file.Status == ConversionStatus.Processing)
                                {
                                    <div class="progress-container">
                                        <div class="progress-bar-wrapper">
                                            <div class="progress-bar" style="width: @file.Progress%"></div>
                                        </div>
                                        <span class="progress-text">@file.Progress%</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="status">@GetStatusText(file.Status)</span>
                                }
                                @if (file.Status == ConversionStatus.Error && !string.IsNullOrEmpty(file.ErrorMessage))
                                {
                                    <div class="error-message">
                                        <span class="error-icon"><HeroIcon Name="exclamation-triangle" Class="w-4 h-4" /></span>
                                        <span class="error-text">@file.ErrorMessage</span>
                                    </div>
                                }
                            </div>
                            <div class="file-actions">
                                @if (file.Status == ConversionStatus.Completed)
                                {
                                    <button class="btn-download" @onclick="() => DownloadFile(file)" title="@Localizer.GetString("Button.Download")">
                                        <HeroIcon Name="arrow-down-tray" Class="w-6 h-6" />
                                    </button>
                                }
                                <button class="btn-remove" @onclick="() => RemoveFile(file)"
                                       disabled="@(file.Status == ConversionStatus.Processing)" title="@Localizer.GetString("Button.Delete")">
                                    <HeroIcon Name="x-mark" Class="w-6 h-6" />
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- 設定パネル -->
        <div class="settings-panel @(isSettingsExpanded ? "expanded" : "collapsed")">
            <div class="settings-header" @onclick="ToggleSettings" role="button" tabindex="0"
                 @onkeydown="@(e => { if (e.Key == "Enter" || e.Key == " ") ToggleSettings(); })"
                 aria-expanded="@isSettingsExpanded" aria-controls="settings-content">
                <h3><HeroIcon Name="cog-6-tooth" Class="w-6 h-6 inline-block mr-2" /> @Localizer.GetString("Settings.Title")</h3>
                <span class="settings-toggle-icon">
                    @if (isSettingsExpanded)
                    {
                        <HeroIcon Name="chevron-down" Class="w-5 h-5" />
                    }
                    else
                    {
                        <HeroIcon Name="chevron-right" Class="w-5 h-5" />
                    }
                </span>
            </div>

            <div id="settings-content" class="settings-content" aria-hidden="@(!isSettingsExpanded)">
                <div class="setting">
                    <label for="jpgQuality">@Localizer.GetString("Settings.JpgQuality"): @((settings.JpgQuality * 100).ToString("F0"))%</label>
                    <input type="range" id="jpgQuality"
                           @bind="settings.JpgQuality"
                           min="@MIN_JPG_QUALITY" max="@MAX_JPG_QUALITY" step="@JPG_QUALITY_STEP" />
                </div>

                <div class="setting">
                    <label>
                        <input type="checkbox" @bind="settings.PreserveExif" />
                        @Localizer.GetString("Settings.PreserveExif")
                    </label>
                </div>

                <div class="setting">
                    <label for="conversionMode">@Localizer.GetString("Settings.ConversionMode")</label>
                    <select id="conversionMode" @bind="settings.ConversionMode">
                        <option value="Auto">@Localizer.GetString("Settings.ConversionMode.Auto")</option>
                        <option value="Fast">@Localizer.GetString("Settings.ConversionMode.Fast")</option>
                        <option value="Quality">@Localizer.GetString("Settings.ConversionMode.HighQuality")</option>
                    </select>
                </div>

                <div class="setting">
                    <label for="parallelCount">@Localizer.GetString("Settings.ParallelCount"): @settings.ParallelCount</label>
                    <input type="range" id="parallelCount"
                           @bind="settings.ParallelCount"
                           min="@MIN_PARALLEL_COUNT" max="@MAX_PARALLEL_COUNT" step="1" />
                </div>

                <div class="setting">
                    <label>
                        <input type="checkbox" @bind="settings.ExtractAudioOnly" />
                        <HeroIcon Name="musical-note" Class="w-4 h-4 inline-block mr-1" /> @Localizer.GetString("Settings.ExtractAudioOnly")
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // 定数定義
    private const int MAX_FILES = 100;
    private const double MIN_JPG_QUALITY = 0.6;
    private const double MAX_JPG_QUALITY = 1.0;
    private const double JPG_QUALITY_STEP = 0.1;
    private const int MIN_PARALLEL_COUNT = 1;
    private const int MAX_PARALLEL_COUNT = 4;
    private const int BYTES_PER_KB = 1024;

    private InputFile? fileInput;
    private List<ConvertFile> files = new();
    private ConversionSettings settings = new();
    private bool isProcessing = false;
    private bool isSettingsExpanded = false; // デフォルトで折りたたみ（初心者向けにシンプルな初期表示）
    private bool isGuideExpanded = false; // 使い方ガイドの初期状態（初心者が必要時に展開）
    private ElementReference dropZoneElement;

    private async Task ScrollToDropZone()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToElement", dropZoneElement);
        }
        catch
        {
            // エラーは無視（古いブラウザ対応）
        }
    }

    private void ToggleGuide()
    {
        isGuideExpanded = !isGuideExpanded;
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        int skippedCount = 0;
        var skippedFiles = new List<string>();

        foreach (var file in e.GetMultipleFiles(MAX_FILES))
        {
            var fileType = GetFileType(file.Name);

            // 対象外ファイルをスキップ
            if (fileType == FileType.Unknown)
            {
                skippedCount++;
                skippedFiles.Add(file.Name);
                continue; // キューに追加しない
            }

            var convertFile = new ConvertFile
            {
                Id = Guid.NewGuid(),
                FileName = file.Name,
                FileSize = file.Size,
                Type = fileType,
                Status = ConversionStatus.Pending,
                OriginalFile = file
            };

            files.Add(convertFile);
        }

        // スキップされたファイルがある場合、トースト通知
        if (skippedCount > 0)
        {
            string message;
            if (skippedCount == 1)
            {
                // 1ファイルのみの場合、ファイル名を含める
                var errorMessage = Localizer.GetString("Error.UnsupportedFileSkipped", skippedFiles[0]);
                var supportedFormats = Localizer.GetString("Error.OnlySupportedFormats");
                message = $"{errorMessage}<br><small>{supportedFormats}</small>";
            }
            else
            {
                // 複数ファイルの場合、件数をまとめて表示
                var errorMessage = Localizer.GetString("Error.MultipleFilesSkipped", skippedCount);
                var supportedFormats = Localizer.GetString("Error.OnlySupportedFormats");
                message = $"{errorMessage}<br><small>{supportedFormats}</small>";
            }
            JS.InvokeVoidAsync("showToast", message, "warning", 6000);
        }

        StateHasChanged();
    }

    private async Task StartConversion()
    {
        isProcessing = true;
        try
        {
            var pendingFiles = files.Where(f => f.Status == ConversionStatus.Pending).ToList();
            await ConvertService.ConvertFilesAsync(pendingFiles, settings, OnProgressUpdate);
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void OnProgressUpdate(Guid fileId, int progress)
    {
        var file = files.FirstOrDefault(f => f.Id == fileId);
        if (file != null)
        {
            file.Progress = progress;
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task DownloadFile(ConvertFile file)
    {
        if (file.ConvertedData != null)
        {
            await JS.InvokeVoidAsync("downloadFile", file.ConvertedData, file.GetConvertedFileName(settings.ExtractAudioOnly));
        }
    }

    private bool IsVideoType(FileType type)
    {
        return type == FileType.MOV || type == FileType.MP4 ||
               type == FileType.AVI || type == FileType.MKV ||
               type == FileType.WMV || type == FileType.FLV ||
               type == FileType.WEBM;
    }

    private bool IsAudioType(FileType type)
    {
        return type == FileType.MP3 || type == FileType.WAV ||
               type == FileType.AAC || type == FileType.M4A ||
               type == FileType.FLAC || type == FileType.WMA;
    }

    private string GetFileIconName(FileType type)
    {
        if (type == FileType.HEIC) return "photo";
        if (type == FileType.MP3 || IsAudioType(type)) return "musical-note";
        if (IsVideoType(type)) return "film";
        return "document";
    }

    private async Task DownloadAll()
    {
        var completedFiles = files.Where(f => f.Status == ConversionStatus.Completed).ToList();
        if (completedFiles.Any())
        {
            await JS.InvokeVoidAsync("downloadFilesAsZip", completedFiles.Select(f => new {
                data = f.ConvertedData,
                fileName = f.GetConvertedFileName(settings.ExtractAudioOnly)
            }).ToArray());
        }
    }

    private void RemoveFile(ConvertFile file)
    {
        files.Remove(file);
        StateHasChanged();
    }

    private void ClearQueue()
    {
        files.Clear();
        StateHasChanged();
    }

    private FileType GetFileType(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".heic" => FileType.HEIC,
            ".mov" => FileType.MOV,
            ".mp4" => FileType.MP4,
            ".avi" => FileType.AVI,
            ".mkv" => FileType.MKV,
            ".wmv" => FileType.WMV,
            ".flv" => FileType.FLV,
            ".webm" => FileType.WEBM,
            ".mp3" => FileType.MP3,
            ".wav" => FileType.WAV,
            ".aac" => FileType.AAC,
            ".m4a" => FileType.M4A,
            ".flac" => FileType.FLAC,
            ".wma" => FileType.WMA,
            _ => FileType.Unknown
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= BYTES_PER_KB && order < sizes.Length - 1)
        {
            order++;
            len = len / BYTES_PER_KB;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetStatusText(ConversionStatus status)
    {
        return status switch
        {
            ConversionStatus.Pending => Localizer.GetString("Status.Pending"),
            ConversionStatus.Processing => Localizer.GetString("Status.Processing"),
            ConversionStatus.Completed => Localizer.GetString("Status.Completed"),
            ConversionStatus.Error => Localizer.GetString("Status.Error"),
            ConversionStatus.Cancelled => Localizer.GetString("Status.Cancelled"),
            _ => Localizer.GetString("Status.Unknown")
        };
    }

    private void ToggleSettings()
    {
        isSettingsExpanded = !isSettingsExpanded;
    }

    protected override void OnInitialized()
    {
        // 言語変更イベントを購読
        Localizer.LanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged(object? sender, EventArgs e)
    {
        // 言語が変更されたらUI再描画
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // イベント購読解除
        Localizer.LanguageChanged -= OnLanguageChanged;
    }
}