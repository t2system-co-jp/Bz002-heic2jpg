# 要件定義書（v0.9）

**プロダクト名**：HEIC2JPG & MOV2MP4
**種別**：ブラウザ内完結型メディア変換アプリ（Blazor WebAssembly）
**作成日**：2025-08-15

---

## 1. 概要

* **目的**：HEIC→JPG、MOV→MP4 の変換を**クラウド送信なし**で完結。ドラッグ&ドロップ、バッチ変換、進捗表示を提供。
* **価値**：社内外での画像・動画の**標準化**と**共有容易化**、セキュア（ローカル処理）かつ**手早い変換**。

---

## 2. スコープ

### 2.1 対象

* 画像：**.heic → .jpg**
* 動画：**.mov → .mp4**
* 単体/複数ファイルのバッチ変換、DLリンクまたはファイル保存（File System Access API）

### 2.2 非対象（初期リリース）

* 逆変換（JPG→HEIC、MP4→MOV）
* 編集機能（切り出し、トリミング、回転、字幕、多重音声）
* クラウド保存、共有リンク、ユーザー管理

---

## 3. 想定ユーザー/ユースケース

* **一般ユーザー**：iPhoneのHEICをJPGにしてWeb提出、SNS投稿。
* **オフィス/現場**：撮影動画のMP4標準化（会議録、教育用、掲示用）。
* **クリエイティブ/CS**：顧客提出前の軽量化・互換性確保。

---

## 4. 成果指標（KPI）

* 直帰変換率（設定デフォルトのまま完了）：**80%+**
* 失敗率（変換エラー/総試行）：**<2%**
* 1分以内に完了する変換割合（単一 200MB以下）：**70%+**（端末依存）

---

## 5. 機能要件

### 5.1 Must（必須）

* ドロップ/選択で複数ファイル受付
* ファイル種別自動判定（拡張子・MIME）
* **HEIC→JPG**：品質（0.6〜1.0）可変、デフォルト0.9

  * EXIF保持/削除の切替（デフォルト：保持）
* **MOV→MP4**：

  1. \*\*リマックス（-c copy）\*\*自動試行（faststart付与）
  2. 失敗時は **H.264/AAC** 再エンコード（preset: veryfast, CRF:23）
* 進捗・残り推定・現在処理中ファイル表示
* キャンセル（ジョブ単位/全体）
* 完了後の一括ダウンロード（Zip）/個別ダウンロード
* エラー理由の表示（簡潔な対処ヒント付き）
* **オフライン動作**（CDN非依存、自己ホスト）
* 日本語UI（英語切替のベースあり）

### 5.2 Should（準必須）

* サムネイル/メタの簡易表示（撮影日時、解像度、長さ）
* 設定のローカル保存（localStorage）
* バッチ時の**並列数**自動調整（CPU/メモリ負荷を見て1〜N）

### 5.3 Could（あれば嬉しい）

* PWAインストール
* ダークモード
* 簡易な**解像度縮小**（JPG：長辺px指定、MP4：720p/1080p）

---

## 6. 非機能要件

* **プライバシー**：データはブラウザ外へ送信しない
* **性能**：

  * HEIC→JPG（12MP）平均<3s（ハイエンド端末）
  * MOV(H.264/AAC, 1080p 1分) リマックス<10s、再エンコードは端末依存
* **互換性**：最新 **Chrome/Edge/Brave**（デスクトップ）推奨。SafariはWASM/COEP制約により限定対応。
* **アクセシビリティ**：キーボード操作、役割/ラベル、コントラスト基準
* **セキュリティ**：

  * COOP/COEP 設定により SharedArrayBuffer 有効化
  * CSP（自己ホストのWASM/JS/Worker のみ許可）
  * WASM/JSのSRI/整合性確認（自己ホスト）

---

## 7. 技術要件/構成

* **フロント**：Blazor WebAssembly (.NET 8/9)
* **ネイティブ変換**：

  * HEIC：`libheif` の WASM ラッパ（RGBA→Canvas→JPEG）
  * 動画：`@ffmpeg/ffmpeg`（WASM, マルチスレッド, Worker）
* **JSインタロップ**：`IJSRuntime` 経由で HEIC/JPEG、FFmpeg を呼び出し
* **ヘッダ**（`index.html`）

  ```html
  <meta http="cross-origin-opener-policy" content="same-origin">
  <meta name="cross-origin-embedder-policy" content="require-corp">
  ```
* **配備**：静的ホスティング（同一オリジンに `ffmpeg-core.*` / heif wasm一式）

---

## 8. 画面/UX要件

### 8.1 画面一覧

* **変換メイン**（単一ページ）

  * ドロップ領域＋ファイル選択
  * キュー一覧（アイコン/ファイル名/種別/サイズ/進捗/推定残り/状態/操作）
  * 設定パネル（右サイド）
  * 完了リスト（DL/フォルダ保存/再実行）
  * フッターにログ/ヘルプ

### 8.2 設定項目（初期値）

* JPG 品質：**0.90**
* EXIF：**保持** / 削除
* MP4 方式：**自動（リマックス優先）**
* 再エンコード設定（必要時）：`preset=veryfast`, `CRF=23`, `音声=192kbps`, `フレームレート=入力維持`
* 同時処理数：**自動**

### 8.3 マイクロコピー（例）

* キュー中：「最速（コピー）を試行中。ダメなら再エンコードします。」
* エラー例：「音声コーデック非対応のため再エンコードに切替えました」「メモリ不足。並列数を下げる/解像度を下げると改善します。」

---

## 9. 入出力仕様

### 9.1 入力制限

* 単ファイル上限：**2GB**（ブラウザ/端末依存で実効は下がる場合あり）
* 総キュー数：**100件**まで（初期）
* 対応コーデック（代表）：

  * MOV：H.264/AAC は**リマックス可**。ProRes/PCM 等は**再エンコード**。

### 9.2 出力仕様

* JPG：拡張子 `.jpg`、カラースペース sRGB、EXIF保持オプション
* MP4：ISO-BMFF、`-movflags +faststart`（ストリーミング最適化）

### 9.3 命名規則

* `元名_YYYYMMDD-HHMMSS_seq.ext`
* 既存重複は `(1)`, `(2)` を付与

### 9.4 メタデータ

* HEIC→JPG：EXIF（撮影日/向き/GPS等）**保持/削除選択**
* MOV→MP4：回転メタ（rotate）維持。再エンコード時は回転を**反映**し正立。

---

## 10. エラーハンドリング（代表）

| コード     | 事象          | 表示/対処              |
| ------- | ----------- | ------------------ |
| E-EXT   | 非対応拡張子/MIME | 対応一覧を案内            |
| E-CODEC | コーデック非対応    | 自動で再エンコードへ切替       |
| E-MEM   | メモリ不足       | 並列数削減・解像度/品質を下げる提案 |
| E-DISK  | 一時FS容量不足    | キュー分割、保存先変更の提案     |
| E-ABORT | ユーザー中断      | 中断済表示/再開不可の明示      |

---

## 11. ログ/テレメトリ

* 画面内ログ（クライアントのみ、DL可）
* 解析は**オプトイン**（匿名・ローカルのみ）。外部送信しない方針。

---

## 12. テスト計画（抜粋）

* **単体**：Interop呼出、品質値境界、命名規則、Zip生成
* **結合**：

  * HEIC(12MP)→JPG 品質0.9/EXIF保持
  * MOV(H.264/AAC, 1080p/60s)→MP4 リマックス成功
  * MOV(ProRes/PCM)→MP4 再エンコード経由で成功
  * 大量（100件×小ファイル）バッチ、キャンセル/再実行
* **性能**：並列1/2/自動で測定、スロットリング確認
* **互換**：Win/Mac/Chromebook、Chrome/Edge

**受け入れ基準（例）**

* 上記4ケースがすべて**成功**、出力再生/閲覧に問題なし
* 変換中キャンセルが該当ジョブにのみ効くこと
* 失敗時に**原因・対処**がUIに表示されること

---

## 13. 運用・配布

* リリース：GitHub Releases（`wwwroot` にWASM/コア同梱）
* バージョニング：SemVer
* 既知問題/回避策をリリースノートに記載

---

## 14. ライセンス/法務

* 使用OSS：`@ffmpeg/ffmpeg`、`libheif`（各ライセンス順守、出典明記）
* 著作権/個人情報：**ローカル処理**である旨を明記。EXIF/GPS扱いの注意喚起。

---

## 15. リスクと対策

* **ブラウザ制約**：COOP/COEP未設定→**必須チェック**を起動時実施
* **端末性能差**：再エンコードが遅い→**並列自動/品質プリセット**
* **大容量**：一時FS/メモリ不足→**分割処理/逐次DL**（将来対応）

---

## 16. マイルストーン（目安）

1. **M1：PoC（2週）**

   * HEIC→JPG/1件、MOV→MP4 リマックスのみ、進捗ログ
2. **M2：β（3週）**

   * バッチ、再エンコード、設定保存、キャンセル、Zip
3. **M3：1.0（2週）**

   * EXIF保持切替、アクセシビリティ、PWA（任意）、安定化

---

## 17. 未確定・要確認事項

* 最大対応サイズ（UIで警告する閾値）：**?**（例：1ファイル1GB、総計5GB）
* 推奨ブラウザの公式サポート範囲（Safariを含むか）：**?**
* Zip 出力の標準化（暗号化要否）：**?**
* 企業利用を想定したブランド/ロゴ・配色ポリシー：**?**

---

## 付録A：ディレクトリ/技術メモ（案）

```
/wwwroot/
  /ffmpeg/ ffmpeg-core.js, wasm, worker.js
  /heif/   libheif.wasm 等
  /interop/ heic.js, ffmpeg.js
Pages/ Index.razor（UI/キュー/設定）
Services/ IConvertService.cs（C#↔JSラッパ）
```

**JS呼出（概略）**

* `heicToJpeg(uint8, quality, keepExif)`
* `movToMp4(uint8, mode=auto)`（auto→copy優先/fallback）

---